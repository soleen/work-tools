# work-tools
Tools to develop kernel, and test it in virtual machines.
- `kbuild` builds it
- `create-image` creates a rootfs image
- `qrun` Runs a qemu image with the built kernel and created rootfs image.

## `kbuild` Script

### Purpose

This script simplifies building the Linux kernel:

* Builds a lightweight kernel configuration suitable for virtualization (`defconfig` + `kvm_guest.config`).
* Performs an out-of-tree build (output placed in `x86_64/` or `arm64/` subdirectory).
* Optionally merges custom configuration options from `pub/pub.config`.
* Automatically performs initial configuration if the `.config` file is missing for the target architecture, or when forced with `-f`.
* Uses parallel make (`-j $(nproc)`) for faster builds.

### Usage

```bash
kbuild [-a ARCH] [-f] [-h]
```

### Options
`-a ARCH `Specify the target architecture. Supported values are `x86_64` and `arm64`. Defaults to `x86_64` if omitted.\
`-f      `Force a clean configuration (`make mrproper`, `make defconfig`, etc.) before building, even if a `.config` file already exists in the output directory (`ARCH/.config`).\
`-h      `Display the help message and exit.\

### Custom Configuration (pub/pub.config)
If a file named `pub/pub.config` exists in the top-level source directory when the configuration sequence is run (see "Automatic Configuration" above), its contents will be appended to the .config file generated by make defconfig. make olddefconfig is then run to integrate these options properly. This provides a convenient way to add or override specific kernel options needed for your build.

### Example Usage (Building `linux-liveupdate`)

1.  **Clone the kernel source repository:**
    ```bash
    git clone git@github.com:googleprodkernel/linux-liveupdate.git
    cd linux-liveupdate
    git checkout -b luo remotes/origin/luo/rfc-v1
    ```

2.  **Create a custom configuration snippet:**
    Create the `pub` directory and add desired options to `pub/pub.config`.
    ```bash
    mkdir pub
    cat << EOF > pub/pub.config
    CONFIG_X86_PMEM_LEGACY_DEVICE=y
    CONFIG_X86_PMEM_LEGACY=y
    CONFIG_MEMORY_HOTPLUG=y
    CONFIG_MEMORY_HOTREMOVE=y
    CONFIG_DAX=y
    CONFIG_KEXEC_FILE=y
    CONFIG_KEXEC_HANDOVER=y
    CONFIG_LIVEUPDATE=y
    CONFIG_LIVEUPDATE_SYSFS_API=y
    CONFIG_SAMPLE_KHO=y
    CONFIG_IGB=y
    CONFIG_IGBVF=y
    CONFIG_PCI_IOV=y
    EOF
    ```

3.  **Run the build script:**

    * **First build for x86_64:**
        ```bash
        kbuild
        ```
        Explanation: This defaults to `-a x86_64`. Since `x86_64/.config` does not exist yet, the script automatically runs the full configuration sequence (including merging `pub/pub.config` if it exists) and then starts the build.
